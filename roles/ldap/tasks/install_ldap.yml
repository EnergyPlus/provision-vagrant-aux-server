---
# guide https://www.server-world.info/en/note?os=CentOS_7&p=openldap&f=1

# [1] Install OpenLDAP Server.
- name: Install the openldap and required Packages for RedHat
  package:
    name={{ item }}
    state=latest
  with_items: "{{ openldap_server_pkgs }}"

- name: Copy DB_CONFIG
  copy:
    src=DB_CONFIG.example
    dest=/var/lib/ldap/DB_CONFIG
    owner=ldap
    group=ldap

- name: Start sldap service
  service:
    name=slapd
    state=restarted
    enabled=yes

# [2] Set OpenLDAP admin password.
- name: Generate OpenLDAP root's password
  shell: slappasswd -s {{ openldap_server_rootpw }}
  register: root_password

- name: Copy templates to configure root, manager & base domain
  template:
    src={{ openldap_chroot_template }}.jinja2
    dest={{ openldap_config_files_folder }}/{{ openldap_chroot_template }}

- name: Set OpenLDAP root password
  shell: "{{ ldap_add }} -f {{ openldap_config_files_folder }}/{{ openldap_chroot_template }}"
  ignore_errors: yes # if the root password is already set it might fail
  notify:
    - restart slapd

# [3] Import basic Schemas.
- name: Import basic Schemas
  shell: "{{ ldap_add }} -f {{ openldap_server_app_path }}/schema/{{ item }}"
  with_items:
    - "{{ openldap_schema_cosine_template }}"
    - "{{ openldap_schema_nis_template }}"
    - "{{ openldap_schema_inetorgperson_template }}"
  ignore_errors: yes # if the schema is already set it might fail
  notify:
    - restart slapd

# [4] Set your domain name on LDAP DB.
- name: Generate OpenLDAP manager's password
  shell: slappasswd -s {{ openldap_server_managerpw }}
  register: manager_password

- name: Copy templates to configure root, manager & base domain
  template:
    src={{ item }}.jinja2
    dest={{ openldap_config_files_folder }}/{{ item }}
  with_items:
    - "{{ openldap_manager_template }}"
    - "{{ openldap_base_domain_template }}"

- name: Modify OpenLDAP admin password
  shell: "{{ ldap_modify }} -f {{ openldap_config_files_folder }}/{{ openldap_manager_template }}"
  ignore_errors: yes # if the manager password is already set it might fail
  notify:
    - restart slapd

- name: add the base domain
  shell: ldapadd -x -D "{{ openldap_manager_dn }}" -w {{ openldap_server_managerpw }} -f {{ openldap_config_files_folder }}/{{ openldap_base_domain_template }} && touch {{ openldap_server_app_path }}/rootdn_created creates={{ openldap_server_app_path }}/rootdn_created
  notify:
    - restart slapd

# [5] If Firewalld is running, allow LDAP service. LDAP uses 389/TCP.
